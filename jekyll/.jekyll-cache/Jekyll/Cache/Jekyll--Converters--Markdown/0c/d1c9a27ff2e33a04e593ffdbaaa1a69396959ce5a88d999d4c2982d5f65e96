I"{<p>Auch wenn es in Deutschland immer noch viele unverschlüsselte Webseiten gibt (HTTP), geht kein Weg an HTTPS vorbei. Alleine schon um ein besseres Google-Ranking zu bekommen.</p>

<p>Es reicht aber nicht, nur HTTPS parallel zu HTTP anzubieten. Aus
Security-Sicht ist es notwendig nur noch HTTPS zu erlauben und alle Anfragen auf HTTP direkt nach HTTPS umzuleiten. Und mit HTTP Strict Transport Security (HSTS) geht man noch einen Schritt weiter: Wenn dem Browser bekannt ist, das eine bestimmte Webseite nur per HTTPS angesprochen werden kann, dann kann er selbstständig HTTP-Anfragen auf HTTPS umstellen. Dadurch lassen sich man-in-the-middle-Attacken wie die in <a href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security#cite_note-14">“New Tricks For Defeating SSL In Practice”</a> besprochene Variante verhindern. Bei der HSTS-Preload-List hält der Browser eine entsprechende Liste von Domain-Namen vor. Er weiß somit, das Anfragen auf wintermeyer-consulting.de und allen Unterdomains auf jeden Fall per HTTPS geschehen müssen. Egal was der User oder eine Mailware eingibt. Als Bonus bekommt man noch einen Tick mehr WebPerformance, weil man sich den Redirect spart.</p>

<h2 id="wie-kommt-man-auf-diese-liste">Wie kommt man auf diese Liste?</h2>

<p>Als erstes muss man seine Webserver-Konfiguration so anpassen, das immer der Header <code class="language-plaintext highlighter-rouge">Strict-Transport-Security: max-age=63072000; includeSubDomains; preload</code> mitgegeben wird. Damit ist dem Webbrowser klar, das diese Domain und alle Subdomains nur per HTTPS ansprechbar sind. Ist dies geschehen, kann man auf  https://hstspreload.org beantragen auf die HSTS-Preload-Liste von Chrome aufgenommen zu werden. Die gleiche Liste wird auch von  Firefox, Opera, Safari, IE 11 und Edge benutzt.</p>

<p>Das Eintragen in die Liste dauert im Schnitt 24-48 Stunden. Danach werden beim nächsten Update alle Browser mit dem Eintrag bestückt. Den Status kann man auf der gleichen Webseite abfragen.</p>

<p><img src="/assets/2017/09/12/hstspreload-screenshot.png" alt="Screenshot" title="HSTS-Preload-Seite Screenshot" /></p>

<p><strong>Wichtig:</strong> Es ist relativ einfach auf die HSTS-Preload-Liste zu kommen. Der umgekehrte Weg ist schwieriger und zeitaufwendiger, da man ja nicht einfach die Einträge per Fingerschnipp auf allen installierten Browsern revoken kann. Man muss also ganz sicher sein, das nicht doch irgend eine API der eigene Webseite von irgend einem Kunden nur per HTTP angefragt werden kann (warum auch immer). Entweder alles HTTPS oder kein Eintrag in der HSTS-Preload-Liste!</p>

<h2 id="nginx-beispiel-konfiguration">Nginx-Beispiel-Konfiguration</h2>

<p>Neben dem <code class="language-plaintext highlighter-rouge">Strict-Transport-Security: max-age=63072000; includeSubDomains; preload</code> Header muss sichergestellt werden, das Anfragen auf http://firma.de auf https://firma.de und Anfragen auf http://www.firma.de auf https://www.firma.de umgeleitet werden. Dabei ist zu beachten, das http://firma.de nicht direkt auf https://www.firma.de umgeleitet werden darf.</p>

<p>Die entsprechende Nginx-Konfiguration ist aber recht einfach. Ein Beispiel:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Virtual Host configuration for www.firma.de
#
server {
	listen 80;
	server_name www.firma.de;

	root /var/www/www.firma.de;
	index  index.html index.htm;

	location / {
	  rewrite ^/(.*)$ https://www.firma.de/$1 permanent;
	  rewrite ^/$ https://www.firma.de/ permanent;
	}
}

server {
	listen 80;
	server_name firma.de;

	root /var/www/www.firma.de;
	index  index.html index.htm;

	location / {
	  rewrite ^/(.*)$ https://firma.de/$1 permanent;
	  rewrite ^/$ https://firma.de/ permanent;
	}
}

server {
	listen 443 ssl http2;
	server_name firma.de;

  # Letsencrypt SSL certificate
	ssl_certificate     /etc/letsencrypt/live/www.firma.de/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/www.firma.de/privkey.pem;

	# Connection credentials caching
	ssl_session_cache shared:SSL:20m;
	ssl_session_timeout 180m;

	# Strict Transport Security
	# =&gt; Tell the client to remember that this is a https site
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

	root /var/www/www.firma.de;
	index  index.html index.htm;

	location / {
	  rewrite ^/(.*)$ https://www.firma.de/$1 permanent;
	  rewrite ^/$ https://www.firma.de/ permanent;
	}
}

server {
	listen 443 ssl http2;
	server_name www.firma.de;

  # Letsencrypt SSL certificate
	ssl_certificate     /etc/letsencrypt/live/www.firma.de/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/www.firma.de/privkey.pem;

	# Connection credentials caching
	ssl_session_cache shared:SSL:20m;
	ssl_session_timeout 180m;

	# Strict Transport Security
	# =&gt; Tell the client to remember that this is a https site
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

	root /var/www/www.firma.de;
	index  index.html index.htm;

	location / {
	  try_files $uri $uri/ =404;
	}
}
</code></pre></div></div>

<h2 id="links">Links</h2>

<ul>
  <li><a href="https://hstspreload.org">https://hstspreload.org</a></li>
  <li><a href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security">https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security</a></li>
  <li><a href="https://www.chromium.org/hsts">https://www.chromium.org/hsts</a></li>
</ul>
:ET